image: node:20

stages:
  - build
  - package

variables:
  PNPM_STORE_DIR: "$CI_PROJECT_DIR/.pnpm-store"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .pnpm-store/

build:
  stage: build
  script:
    - corepack enable
    - pnpm install --frozen-lockfile
    - pnpm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

package:
  stage: package
  needs:
    - job: build
      artifacts: true
  script:
    - corepack enable
    - pnpm install --frozen-lockfile
    - pnpm run package
    - mv ./*.vsix cursor-usage.vsix
  artifacts:
    name: "cursor-usage-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    expose_as: "VSIX Package"
    paths:
      - cursor-usage.vsix
    expire_in: 2 weeks
