stages:
  - build
  - package
  - release

variables:
  PNPM_STORE_DIR: "$CI_PROJECT_DIR/.pnpm-store"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .pnpm-store/

build:
  stage: build
  script:
    - pnpm install --frozen-lockfile
    - pnpm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

package:
  stage: package
  needs:
    - job: build
      artifacts: true
  script:
    - pnpm install --frozen-lockfile
    - pnpm run package
    - mv ./*.vsix cursor-usage.vsix
  artifacts:
    name: "cursor-usage-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    expose_as: "VSIX Package"
    paths:
      - cursor-usage.vsix
    expire_in: 2 weeks

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: package
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release $CI_COMMIT_TAG"
  artifacts:
    paths:
      - cursor-usage.vsix
    expire_in: 1 year
  release:
    tag_name: "$CI_COMMIT_TAG"
    name: "Release $CI_COMMIT_TAG"
    description: "Automated release for $CI_COMMIT_TAG"
    assets:
      links:
        - name: "VSIX Package"
          url: "$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/cursor-usage.vsix"
          filepath: "/cursor-usage.vsix"
